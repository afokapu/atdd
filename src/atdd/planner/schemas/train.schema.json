{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Train Schema",
  "description": "Schema for train definitions orchestrating multi-wagon workflows with theme-based numbering",
  "type": "object",
  "additionalProperties": false,
  "$comment": "Trains use hierarchical numbering [Theme][Category][Variation] (0001-0099: commons nominal, 0101-0199: commons error, etc.) where first digit = theme (0-9), second digit = category (0=nominal, 1=error, 2=alternate, 3=exception), third-fourth digits = variation (01-99)",
  "required": [
    "train_id",
    "title",
    "description",
    "themes",
    "participants",
    "sequence"
  ],
  "properties": {
    "train_id": {
      "type": "string",
      "pattern": "^\\d{4}-[a-z0-9-]+$",
      "description": "Train identifier with hierarchical numbering: {theme}{category}{variation}-{kebab-case-name} (e.g., 0001-auth-session-standard, 2301-empty-input-file)"
    },
    "title": {
      "type": "string",
      "minLength": 3,
      "description": "Human-readable display name for the train"
    },
    "description": {
      "type": "string",
      "minLength": 10,
      "description": "Concise description of the train's purpose and workflow"
    },
    "path": {
      "type": "string",
      "description": "Canonical path to the train YAML file relative to repo root"
    },
    "file": {
      "type": "string",
      "description": "DEPRECATED: Use 'path' instead. Alias for backward compatibility",
      "deprecated": true
    },
    "themes": {
      "type": "array",
      "description": "Theme categories this train belongs to",
      "minItems": 1,
      "items": {
        "type": "string",
        "enum": [
          "commons",
          "mechanic",
          "scenario",
          "match",
          "sensory",
          "player",
          "league",
          "audience",
          "monetization",
          "partnership"
        ]
      }
    },
    "primary_wagon": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "The primary wagon responsible for this train's core functionality"
    },
    "dependencies": {
      "type": "array",
      "description": "Other trains that must run before this train",
      "items": {
        "type": "string",
        "pattern": "^train:\\d{4}-[a-z0-9-]+$",
        "description": "Train reference in format: train:{train_id}"
      }
    },
    "participants": {
      "type": "array",
      "description": "Wagons, users, and systems involved in this train",
      "minItems": 1,
      "items": {
        "type": "string",
        "pattern": "^(wagon|user|system):[a-z][a-z0-9-]*$",
        "description": "Participant reference: wagon:{wagon-id}, user:{role}, system:{source}"
      }
    },
    "test": {
      "oneOf": [
        {
          "type": "string",
          "description": "Single backend test file path"
        },
        {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of backend test file paths"
        },
        {
          "type": "object",
          "properties": {
            "backend": {
              "oneOf": [
                { "type": "string" },
                { "type": "array", "items": { "type": "string" } }
              ],
              "description": "Backend test file path(s)"
            },
            "frontend": {
              "oneOf": [
                { "type": "string" },
                { "type": "array", "items": { "type": "string" } }
              ],
              "description": "Frontend (web) test file path(s)"
            },
            "frontend_python": {
              "oneOf": [
                { "type": "string" },
                { "type": "array", "items": { "type": "string" } }
              ],
              "description": "Frontend Python (Streamlit) test file path(s)"
            }
          },
          "additionalProperties": false,
          "description": "Test files organized by platform"
        }
      ],
      "description": "Test file references for this train (string, array, or object with backend/frontend/frontend_python)"
    },
    "code": {
      "oneOf": [
        {
          "type": "string",
          "description": "Single backend implementation file path"
        },
        {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of backend implementation file paths"
        },
        {
          "type": "object",
          "properties": {
            "backend": {
              "oneOf": [
                { "type": "string" },
                { "type": "array", "items": { "type": "string" } }
              ],
              "description": "Backend implementation file path(s)"
            },
            "frontend": {
              "oneOf": [
                { "type": "string" },
                { "type": "array", "items": { "type": "string" } }
              ],
              "description": "Frontend (web) implementation file path(s)"
            },
            "frontend_python": {
              "oneOf": [
                { "type": "string" },
                { "type": "array", "items": { "type": "string" } }
              ],
              "description": "Frontend Python (Streamlit) implementation file path(s)"
            }
          },
          "additionalProperties": false,
          "description": "Implementation files organized by platform"
        }
      ],
      "description": "Implementation file references for this train (string, array, or object with backend/frontend/frontend_python)"
    },
    "expectations": {
      "type": "object",
      "properties": {
        "backend": {
          "type": "boolean",
          "description": "Whether backend implementation is expected"
        },
        "frontend": {
          "type": "boolean",
          "description": "Whether frontend (web) implementation is expected"
        },
        "frontend_python": {
          "type": "boolean",
          "description": "Whether frontend Python (Streamlit) implementation is expected"
        }
      },
      "additionalProperties": false,
      "description": "Explicit expectations for which platforms this train should be implemented on"
    },
    "status": {
      "type": "string",
      "enum": ["planned", "tested", "implemented"],
      "default": "planned",
      "description": "Current implementation status of the train"
    },
    "sequence": {
      "type": "array",
      "description": "Ordered steps, loops, and routes defining the train workflow",
      "minItems": 1,
      "items": {
        "oneOf": [
          { "$ref": "#/definitions/step" },
          { "$ref": "#/definitions/loop" },
          { "$ref": "#/definitions/route" }
        ]
      }
    }
  },
  "definitions": {
    "step": {
      "type": "object",
      "required": ["step", "intent", "from", "to", "artifact"],
      "additionalProperties": false,
      "properties": {
        "step": {
          "type": "integer",
          "minimum": 1,
          "description": "Step number in sequence"
        },
        "intent": {
          "type": "string",
          "minLength": 5,
          "description": "What this step accomplishes"
        },
        "from": {
          "type": "string",
          "pattern": "^(wagon|user|system):[a-z][a-z0-9-]*$",
          "description": "Source participant"
        },
        "to": {
          "type": "string",
          "pattern": "^(wagon|user|system):[a-z][a-z0-9-]*$",
          "description": "Destination participant"
        },
        "artifact": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*:[a-z][a-z0-9.-]*$",
          "description": "Artifact passed between participants (domain:resource format)"
        }
      }
    },
    "loop": {
      "type": "object",
      "required": ["loop"],
      "additionalProperties": false,
      "properties": {
        "loop": {
          "type": "object",
          "required": ["name", "condition", "steps"],
          "additionalProperties": false,
          "properties": {
            "name": {
              "type": "string",
              "minLength": 3,
              "description": "Loop identifier"
            },
            "condition": {
              "type": "string",
              "minLength": 5,
              "description": "Loop continuation/exit condition"
            },
            "steps": {
              "type": "array",
              "minItems": 1,
              "items": {
                "oneOf": [
                  { "$ref": "#/definitions/step" },
                  { "$ref": "#/definitions/route" }
                ]
              }
            }
          }
        }
      }
    },
    "route": {
      "type": "object",
      "required": ["route"],
      "additionalProperties": false,
      "properties": {
        "route": {
          "type": "object",
          "required": ["name", "branches"],
          "additionalProperties": false,
          "properties": {
            "name": {
              "type": "string",
              "minLength": 3,
              "description": "Route identifier"
            },
            "branches": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "object",
                "required": ["condition", "steps"],
                "additionalProperties": false,
                "properties": {
                  "condition": {
                    "type": "string",
                    "minLength": 5,
                    "description": "Branch condition"
                  },
                  "steps": {
                    "type": "array",
                    "minItems": 1,
                    "items": { "$ref": "#/definitions/step" }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
